# This file's semantics are documented at
# https://docs.gitlab.com/ce/ci/yaml/README.html

default:
  image: chreekat2/snowdrift-ci:0.0.2

variables:
  SD_STACK_ARGS: "--stack-root ${CI_PROJECT_DIR}/stack-root"
  SD_PGUSER: "postgres"

stages:
  - deps
  - build
  - test
  - deploy-build
  - deploy

cache:
  paths: [stack-root]
  policy: pull


deps:
  stage: deps
  script: stack ${SD_STACK_ARGS} test --only-dependencies
  cache:
    paths: [stack-root]
    policy: pull-push
  artifacts:
    paths:
      - .stack-work

# Build for test
test-build:
  stage: build
  script:
    - touch website/src/Settings/StaticFiles.hs
    - stack ${SD_STACK_ARGS} test --no-run-tests
  artifacts:
    paths:
      - .stack-work

# Build for deploy, using --pedantic
deploy-build:
  stage: build
  script:
    - DEPLOY=false ./ci-support/deploy
  # Don't force pedantry on people.
  allow_failure: true
  artifacts:
    paths:
      - Snowdrift.keter

test:
  stage: test
  script: ./build.sh test
  dependencies: [test-build]
  artifacts:
    paths:
      - .stack-work

deploy:
  stage: deploy
  script:
    - adduser postgres
    - BUILD=false ./ci-support/deploy
  only:
    # Only deploy from master.
    #
    # This is not a security measure, since someone could push a branch that
    # changes this line. It's a convenience. Security is maintained by only
    # allowing production secrets to be sent to protected branches.
    - master@sd/snowdrift
  # The scheduled runs don't get deployed.
  except:
    - schedules
  when: manual
  environment:
    name: production
    url: https://snowdrift.coop
  dependencies: [deploy-build]
