# This file's semantics are documented at
# https://docs.gitlab.com/ce/ci/yaml/README.html

default:
  image: snowdriftcoop/snowdrift-ci:0.0.6

variables:
  SD_STACK_ARGS: "--stack-root ${CI_PROJECT_DIR}/stack-root"
  POSTGRES_DATABASE: snowdrift_test


stages:
  - deps
  - build and test
  - deploy

cache:
  paths: [stack-root]
  policy: pull


deps:
  stage: deps
  script: stack ${SD_STACK_ARGS} test --only-dependencies
  cache:
    paths: [stack-root]
    policy: pull-push
  artifacts:
    paths:
      - .stack-work
  only:
    changes:
      - stack.yaml

build and test:
  stage: build and test
  services: ["postgres:9.3"]
  script:
    - PGUSER=postgres PGHOST=postgres stack ${SD_STACK_ARGS} test --fast
